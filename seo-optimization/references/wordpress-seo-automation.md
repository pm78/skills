# WordPress SEO Automation via REST API

Playbook for automating SEO fixes on WordPress sites using the WP REST API + Code Snippets plugin.

## Prerequisites

- WordPress site with REST API enabled (default)
- Application Password for an admin user (wp-admin > Users > Application Passwords)
- Code Snippets plugin active (for operations not exposed by REST API)
- Rank Math or Yoast SEO plugin (for meta descriptions, schema)

## Authentication

WordPress Application Passwords with spaces require explicit Base64 encoding:

```bash
# WRONG — curl -u fails with spaces in password
curl -u "user:pass word" https://site.com/wp-json/wp/v2/posts

# CORRECT — explicit Base64 Authorization header
AUTH=$(echo -n "user:pass word" | base64)
curl -H "Authorization: Basic $AUTH" https://site.com/wp-json/wp/v2/posts
```

**Gotcha**: Some hosts redirect `www` to non-www (or vice versa) and DROP the Authorization header during redirect. Always use the canonical URL (test with `curl -I`).

## Audit Sequence

Run these checks first to build a complete picture before making changes:

```bash
AUTH=$(echo -n "user:password" | base64)
BASE="https://site.com"

# 1. Site settings (title, tagline, default category, site URL http vs https)
curl -s -H "Authorization: Basic $AUTH" "$BASE/wp-json/wp/v2/settings"

# 2. API root — check namespaces for installed plugins (rank-math, yatra, woocommerce, etc.)
curl -s "$BASE/wp-json/" | python3 -c "import sys,json; print(json.dumps(json.load(sys.stdin).get('namespaces'), indent=2))"

# 3. All posts (titles, slugs, links, categories, tags, authors, meta incl. Rank Math fields)
curl -s -H "Authorization: Basic $AUTH" "$BASE/wp-json/wp/v2/posts?per_page=100&_fields=id,title,slug,link,categories,tags,author,date,modified,meta,featured_media,excerpt"

# 4. All categories (check for "Non classé", empty categories)
curl -s -H "Authorization: Basic $AUTH" "$BASE/wp-json/wp/v2/categories?per_page=50&_fields=id,name,slug,count,description"

# 5. All tags (check for orphaned/zero-count tags, junk tags, duplicates)
curl -s -H "Authorization: Basic $AUTH" "$BASE/wp-json/wp/v2/tags?per_page=100&_fields=id,name,slug,count"

# 6. All pages (check for junk: sample page, plugin-generated pages like Yatra)
curl -s -H "Authorization: Basic $AUTH" "$BASE/wp-json/wp/v2/pages?per_page=100&_fields=id,title,slug,status,meta"

# 7. All users (check for "admin" display names, missing bios, bad slugs)
curl -s -H "Authorization: Basic $AUTH" "$BASE/wp-json/wp/v2/users?_fields=id,name,slug,description,url"

# 8. Navigation menus
curl -s -H "Authorization: Basic $AUTH" "$BASE/wp-json/wp/v2/menu-items?per_page=50&_fields=id,title,url,menu_order"

# 9. Sample media (check alt text)
curl -s -H "Authorization: Basic $AUTH" "$BASE/wp-json/wp/v2/media?per_page=10&_fields=id,title,alt_text,source_url"

# 10. Sitemap check (try both Rank Math and WP core)
curl -s -o /dev/null -w "%{http_code}" "$BASE/sitemap_index.xml"  # Rank Math
curl -s -o /dev/null -w "%{http_code}" "$BASE/wp-sitemap.xml"      # WP core

# 11. Homepage HTML — check meta desc, OG, canonical, schema, heading structure
curl -s "$BASE/" | grep -i 'description\|og:\|twitter:\|canonical\|ld+json\|rank.math'

# 12. Permalink structure (look for /index.php/ in post links)
# If post links contain /index.php/, permalinks need fixing

# NOTE: /wp/v2/plugins returns 401 with Application Passwords — cannot list/activate/deactivate plugins via API
```

### Tag Audit & Cleanup

Tags are a common source of SEO pollution. Check for:
- **Zero-count tags** that create empty archive pages indexed in sitemap
- **Junk tags** auto-generated by AI tools (e.g., "Analysis", "Data", "Test", "Summary", "Conclusion")
- **Off-topic tags** from a previous site iteration (e.g., NFL/sports tags on a coaching site)
- **Duplicate tags** in multiple languages or spelling variants
- **Typos** (trailing periods, wrong words like "mentory" instead of "mentoring")

```bash
# Delete all zero-count tags
curl -s -H "Authorization: Basic $AUTH" "$BASE/wp-json/wp/v2/tags?per_page=100" | \
  python3 -c "import sys,json; [print(t['id']) for t in json.load(sys.stdin) if t['count']==0]" | \
  while read id; do
    curl -s -X DELETE -H "Authorization: Basic $AUTH" "$BASE/wp-json/wp/v2/tags/$id?force=true" > /dev/null
    echo "Deleted tag $id"
  done
```

## Common SEO Fixes

### 1. Site Title & Tagline

Bad: "Actualités, trucs et astuces pour les coachs — les news"
Good: "Les News du Coach — Veille marché et stratégie pour coachs indépendants"

```bash
curl -s -X POST -H "Authorization: Basic $AUTH" -H "Content-Type: application/json" \
    "$BASE/wp-json/wp/v2/settings" \
    -d '{"title":"Site Name","description":"Keyword-rich tagline under 60 chars"}'
```

Rules:
- Title: brand name, concise, recognizable
- Tagline: include primary keyword, describe the site's value proposition
- Both appear in `<title>` of every page, so keep them tight

### 2. Fix Permalinks (remove /index.php/ and dates)

The REST API doesn't expose `permalink_structure`. Use Code Snippets:

```php
// Snippet 1: Change permalink structure (runs once via admin_init)
add_action('admin_init', function() {
    $current = get_option('permalink_structure');
    if ($current !== '/%postname%/') {
        update_option('permalink_structure', '/%postname%/');
        flush_rewrite_rules();
    }
});
```

If new URLs return 404, the `.htaccess` needs WordPress rewrite rules:

```php
// Snippet 2: Force .htaccess rewrite rules (run once, then deactivate)
add_action('admin_init', function() {
    $htaccess = ABSPATH . '.htaccess';
    $current = file_exists($htaccess) ? file_get_contents($htaccess) : '';
    if (strpos($current, 'RewriteBase /') === false) {
        $rules = "# BEGIN WordPress\n<IfModule mod_rewrite.c>\nRewriteEngine On\nRewriteBase /\n";
        $rules .= "RewriteRule ^index\\.php$ - [L]\nRewriteCond %{REQUEST_FILENAME} !-f\n";
        $rules .= "RewriteCond %{REQUEST_FILENAME} !-d\nRewriteRule . /index.php [L]\n";
        $rules .= "</IfModule>\n# END WordPress\n";
        file_put_contents($htaccess, $rules . "\n" . $current);
    }
    flush_rewrite_rules(true);
});
```

**Important**: After confirming new URLs work (HTTP 200), trigger admin_init:
```bash
curl -s -H "Authorization: Basic $AUTH" "$BASE/wp-admin/admin-ajax.php?action=heartbeat"
```

Then deactivate the .htaccess snippet (keep only the redirect snippet active).

### 3. 301 Redirects for Old URLs

Keep this snippet permanently active to redirect old date-based URLs:

```php
// Persistent snippet: 301 redirect /YYYY/MM/DD/slug/ → /slug/
add_action('template_redirect', function() {
    $path = strtok($_SERVER['REQUEST_URI'], '?');
    $pattern = '@^(/index\\.php)?/\\d{4}/\\d{2}/\\d{2}/([a-z0-9][a-z0-9\\-]*)/?$@i';
    if (preg_match($pattern, $path, $matches)) {
        $slug = $matches[2];
        $posts = get_posts(array(
            'name' => $slug,
            'post_type' => 'post',
            'post_status' => 'publish',
            'numberposts' => 1
        ));
        if (!empty($posts)) {
            $new_url = get_permalink($posts[0]->ID);
            if ($new_url) {
                wp_redirect($new_url, 301);
                exit;
            }
        }
    }
});
```

After permalink changes, also update all internal links in article content:
```python
import re, requests, base64

# Pattern to match old URLs in content
old_pattern = re.compile(r'https?://site\.com/index\.php/\d{4}/\d{2}/\d{2}/([a-z0-9][a-z0-9\-]*)/?')

for post in posts:
    content = get_content(post['id'])
    new_content = old_pattern.sub(lambda m: slug_to_url.get(m.group(1), m.group(0)), content)
    if new_content != content:
        update_content(post['id'], new_content)
```

### 4. Category Restructuring

Common issues:
- "Non classé" / "Uncategorized" with articles in it
- Empty categories in sitemap
- Categories that don't match navigation menu
- Generic names ("Economie") instead of SEO-targeted names ("Marché du coaching")

```bash
# Create SEO-friendly category
curl -s -X POST -H "Authorization: Basic $AUTH" -H "Content-Type: application/json" \
    "$BASE/wp-json/wp/v2/categories" \
    -d '{"name":"Marché du coaching","slug":"marche-du-coaching","description":"Keyword-rich description"}'

# Reassign post to new category
curl -s -X POST -H "Authorization: Basic $AUTH" -H "Content-Type: application/json" \
    "$BASE/wp-json/wp/v2/posts/POST_ID" \
    -d '{"categories":[NEW_CAT_ID]}'

# Change default category (before deleting "Non classé")
curl -s -X POST -H "Authorization: Basic $AUTH" -H "Content-Type: application/json" \
    "$BASE/wp-json/wp/v2/settings" \
    -d '{"default_category":NEW_CAT_ID}'

# Delete empty category
curl -s -X DELETE -H "Authorization: Basic $AUTH" \
    "$BASE/wp-json/wp/v2/categories/OLD_CAT_ID?force=true"
```

**Checklist**: After restructuring categories, update the navigation menu to match:
```bash
# Update menu item
curl -s -X POST -H "Authorization: Basic $AUTH" -H "Content-Type: application/json" \
    "$BASE/wp-json/wp/v2/menu-items/ITEM_ID" \
    -d '{"title":"New Label","url":"https://site.com/category/new-slug/","type":"taxonomy","object":"category","object_id":CAT_ID}'

# Add new menu item
curl -s -X POST -H "Authorization: Basic $AUTH" -H "Content-Type: application/json" \
    "$BASE/wp-json/wp/v2/menu-items" \
    -d '{"title":"Label","url":"...","type":"taxonomy","object":"category","object_id":CAT_ID,"menus":MENU_ID,"menu_order":N,"status":"publish"}'
```

### 5. Rank Math Meta via REST API

Rank Math doesn't expose its fields in REST API by default. Deploy this persistent snippet:

```php
// Expose Rank Math SEO fields in WordPress REST API
add_action('init', function() {
    $fields = array('rank_math_title', 'rank_math_description', 'rank_math_focus_keyword', 'rank_math_robots');
    foreach (array('post', 'page') as $type) {
        foreach ($fields as $field) {
            register_post_meta($type, $field, array(
                'show_in_rest' => true,
                'single' => true,
                'type' => 'string',
                'auth_callback' => function() { return current_user_can('edit_posts'); }
            ));
        }
    }
});
```

Then set meta descriptions via standard REST API:
```bash
curl -s -X POST -H "Authorization: Basic $AUTH" -H "Content-Type: application/json" \
    "$BASE/wp-json/wp/v2/posts/POST_ID" \
    -d '{"meta":{"rank_math_title":"SEO Title (50-60 chars)","rank_math_description":"Meta description (150-160 chars)","rank_math_focus_keyword":"primary keyword"}}'
```

**For Yoast SEO**: Same approach, but field names are `_yoast_wpseo_title`, `_yoast_wpseo_metadesc`, `_yoast_wpseo_focuskw`.

### 6. Internal Linking (Maillage Interne)

Strategy:
- Every article should have 2-3 contextual internal links
- Link to thematically related articles (not just random)
- Place "À lire aussi" blocks before the Sources/References section
- Use descriptive anchor text (not "cliquez ici")

Implementation via Python:
```python
# Build URL map from current posts
posts = get_all_posts()
slug_to_url = {p['slug']: p['link'] for p in posts}

# For each article, insert contextual links
# Option A: Before the Sources/References heading
content = content.replace(
    "<h2>Sources</h2>",
    f'<p><strong>À lire aussi :</strong> <a href="{url1}">Title 1</a> — et <a href="{url2}">Title 2</a>.</p>\n<h2>Sources</h2>'
)

# Option B: Inline anchor in existing text
content = content.replace(
    "existing text phrase",
    f'<a href="{url}">existing text phrase</a>'
)
```

### 7. Author Profiles & E-E-A-T

Fix generic author names ("admin", "admin3330"):
```bash
curl -s -X POST -H "Authorization: Basic $AUTH" -H "Content-Type: application/json" \
    "$BASE/wp-json/wp/v2/users/USER_ID" \
    -d '{"name":"Display Name","nickname":"Display Name","first_name":"First","description":"Professional bio with credentials","url":"https://linkedin.com/in/profile"}'
```

Reassign all posts to the correct author:
```bash
curl -s -X POST -H "Authorization: Basic $AUTH" -H "Content-Type: application/json" \
    "$BASE/wp-json/wp/v2/posts/POST_ID" \
    -d '{"author":USER_ID}'
```

### 8. About Page (E-E-A-T)

Essential for YMYL-adjacent topics (coaching, health, finance). Must include:
- **Photo** (real, professional — check LinkedIn, company site, ICF directory)
- **Name and role**
- **Credentials** (certifications, education)
- **Experience** (concrete, not vague)
- **Links** (LinkedIn, professional directory listings)
- **Contact method** (email, form)
- **Internal links** to content categories

Upload author photo:
```bash
curl -s -X POST -H "Authorization: Basic $AUTH" \
    -H "Content-Disposition: attachment; filename=author-photo.jpg" \
    -H "Content-Type: image/jpeg" \
    --data-binary @/tmp/photo.jpg \
    "$BASE/wp-json/wp/v2/media"
```

**Gotcha**: Don't set both `featured_media` AND an inline `<img>` — many themes display the featured image automatically, causing duplicates. Use inline image only.

### 9. Fix Bad Slugs

Articles created with placeholder titles get useless slugs like `article-n1`:
```bash
curl -s -X POST -H "Authorization: Basic $AUTH" -H "Content-Type: application/json" \
    "$BASE/wp-json/wp/v2/posts/POST_ID" \
    -d '{"slug":"descriptive-keyword-rich-slug"}'
```

### 10. Cleanup

After completing all fixes:
- Delete unused pages (sample page, plugin-generated pages like Yatra)
- Remove empty categories
- Deactivate one-time Code Snippets (keep redirect and Rank Math snippets active)
- Verify sitemap reflects new structure: `curl $BASE/wp-sitemap.xml`
- Check no orphan pages exist

## Code Snippets REST API Reference

The Code Snippets plugin exposes `$BASE/wp-json/code-snippets/v1/snippets`:

```bash
# List all snippets
curl -s -H "Authorization: Basic $AUTH" "$BASE/wp-json/code-snippets/v1/snippets"

# Create snippet
curl -s -X POST -H "Authorization: Basic $AUTH" -H "Content-Type: application/json" \
    "$BASE/wp-json/code-snippets/v1/snippets" \
    -d '{"name":"Name","code":"PHP code","active":true,"scope":"global","priority":10}'

# Update snippet
curl -s -X PUT -H "Authorization: Basic $AUTH" -H "Content-Type: application/json" \
    "$BASE/wp-json/code-snippets/v1/snippets/ID" \
    -d '{"code":"new code","active":true}'

# Deactivate snippet
curl -s -X PUT -H "Authorization: Basic $AUTH" -H "Content-Type: application/json" \
    "$BASE/wp-json/code-snippets/v1/snippets/ID" \
    -d '{"active":false}'
```

### 11. Remove WP Core Duplicate Tags

When deploying a custom SEO meta snippet, WP core outputs its own canonical and robots. Suppress them:

```php
/* Add at top of SEO meta snippet, OUTSIDE the wp_head hook */
remove_action('wp_head', 'rel_canonical');
remove_action('wp_head', 'wp_robots', 11);
add_filter('wp_robots', '__return_empty_array', 99);
```

**Important**: `remove_action('wp_head', 'wp_robots', 11)` alone is NOT enough — you must also add the `__return_empty_array` filter to fully suppress the core robots meta.

### 12. Override `<title>` with Rank Math Title

WP's `wp_get_document_title()` ignores Rank Math fields. Filter it:

```php
add_filter('pre_get_document_title', function () {
    $post_id = get_queried_object_id();
    if ($post_id) {
        $rm_title = get_post_meta($post_id, 'rank_math_title', true);
        if (!empty($rm_title)) return $rm_title;
    }
    if (is_category()) {
        return get_queried_object()->name . ' — ' . get_bloginfo('name');
    }
    return '';  /* fall back to WP default */
}, 10);
```

### 13. Category Archive SEO

Extend the SEO meta snippet to handle `is_category()`:

```php
if ($is_category) {
    $cat = get_queried_object();
    $seo_title = $cat->name . ' — ' . $site_name;
    $seo_desc  = $cat->description ?: 'Articles sur ' . $cat->name;
    $canonical = get_category_link($cat->term_id);
    // Also output CollectionPage JSON-LD
}
```

### 14. Author Archive Redirect

Since author slugs can't be changed via REST API, redirect to About page:

```php
add_action('template_redirect', function () {
    if (is_author()) {
        wp_redirect(home_url('/a-propos/'), 301);
        exit;
    }
});
```

### 15. Close Comments

```bash
# Close default comment/ping status
curl -s -X POST -H "Authorization: Basic $AUTH" -H "Content-Type: application/json" \
    "$BASE/wp-json/wp/v2/settings" \
    -d '{"default_comment_status":"closed","default_ping_status":"closed"}'

# Close on all existing posts
for pid in $(curl -s -H "Authorization: Basic $AUTH" "$BASE/wp-json/wp/v2/posts?per_page=100&_fields=id" | python3 -c "import sys,json; [print(p['id']) for p in json.load(sys.stdin)]"); do
    curl -s -X POST -H "Authorization: Basic $AUTH" -H "Content-Type: application/json" \
        "$BASE/wp-json/wp/v2/posts/$pid" \
        -d '{"comment_status":"closed","ping_status":"closed"}' > /dev/null
done
```

### 16. Browser Cache Headers

When `.htaccess` is not writable, use a PHP snippet:

```php
add_action('send_headers', function () {
    if (is_admin() || is_user_logged_in()) return;
    header('Cache-Control: public, max-age=600, s-maxage=3600, stale-while-revalidate=86400');
    header_remove('Pragma');
    header_remove('Expires');
});
```

### 17. llms.txt via Code Snippet

**Must use `parse_request` hook** — `template_redirect` returns 404 for non-WP URLs:

```php
add_action('parse_request', function ($wp) {
    if ($wp->request !== 'llms.txt' &&
        (!isset($_SERVER['REQUEST_URI']) || rtrim(strtok($_SERVER['REQUEST_URI'], '?'), '/') !== '/llms.txt')) {
        return;
    }
    header('Content-Type: text/plain; charset=utf-8');
    header('Cache-Control: public, max-age=86400');
    echo "# Site Name\n> Tagline\n\n## About\n...";
    exit;
});
```

### 18. BreadcrumbList JSON-LD

Add to the SEO meta snippet's JSON-LD section:

```php
$breadcrumb_items = [
    ['@type' => 'ListItem', 'position' => 1, 'name' => 'Accueil', 'item' => $site_url . '/'],
];
if ($is_single) {
    $cats = get_the_category($post_id);
    if (!empty($cats)) {
        $breadcrumb_items[] = ['@type' => 'ListItem', 'position' => 2,
            'name' => $cats[0]->name, 'item' => get_category_link($cats[0]->term_id)];
        $breadcrumb_items[] = ['@type' => 'ListItem', 'position' => 3,
            'name' => get_the_title($post_id), 'item' => get_permalink($post_id)];
    }
}
if (count($breadcrumb_items) > 1) {
    $jsonld[] = ['@context' => 'https://schema.org', '@type' => 'BreadcrumbList',
        'itemListElement' => $breadcrumb_items];
}
```

## Full Automated Audit + Fix Sequence

1. **Audit**: settings, posts, categories, tags, users, menus, plugins, sitemap. Also check: duplicate canonical/robots counts, internal link counts per article, `llms.txt`, cache headers, OG image dimensions, comment status, duplicate post titles (keyword cannibalization).
2. **Title/tagline**: update with keywords
3. **Permalinks**: switch to `/%postname%/`, fix .htaccess, add 301 redirects
4. **Tags**: audit for junk/AI-generated/English-on-French-site tags. If all are low-value, delete ALL (remove from posts first with `{"tags":[]}`, then delete tags). Then create 20-30 meaningful topic-cluster tags and assign 3-5 per post.
5. **Categories**: create SEO-friendly ones, reassign posts, delete empty ones, update default. Ensure indexed (Yoast: set `noindex-tax-category` to `false` in `wpseo_titles` option).
6. **Menu**: align navigation with new categories + add "À propos"
7. **SEO plugin meta**: expose Rank Math/Yoast fields, write meta descriptions + focus keywords
8. **Duplicate content**: detect near-duplicate titles, merge content into stronger post, draft the weaker, deploy 301 redirects via Code Snippet using `init` hook
9. **SEO meta snippet**: deploy with meta desc, OG, Twitter, JSON-LD, canonical, BreadcrumbList, category archive support. Remove WP core duplicates (`rel_canonical` + `wp_robots`). Override `<title>` via `pre_get_document_title`.
10. **Internal links**: add 3-5 contextual links per article using topic-cluster scoring (check all articles, fix orphans)
11. **Authors**: fix display names, add bios, upload photos, reassign posts. Redirect `/author/*` to `/a-propos/`.
12. **About page**: create with E-E-A-T content, photo, credentials, links
13. **Featured images**: batch-generate via OpenAI `gpt-image-1` (b64_json), upload via multipart form to WP media API, set as `featured_media`
14. **Static homepage**: create curated landing page with category links, set `show_on_front=page`, `page_on_front`, `page_for_posts`
15. **Auto TOC**: deploy `the_content` filter snippet to generate Table of Contents from H2/H3 headings
16. **FAQ Schema**: deploy `wp_footer` snippet to inject FAQPage JSON-LD for posts with 2+ question headings. Use `strpos` not `preg_match(..., PREG_OFFSET_MATCH)` to avoid PHP crashes.
17. **Close comments**: `default_comment_status` + `default_ping_status` to `closed`, close on all existing posts
18. **Cache headers**: deploy `send_headers` snippet for browser caching
19. **llms.txt**: deploy via `parse_request` hook (NOT `template_redirect`)
20. **OG social image**: generate 1200x630 image, upload, reference in SEO meta snippet
21. **Cleanup**: delete junk pages, deactivate temp snippets, verify sitemap

### Code Snippets API Reliability

When updating snippet code via PUT:
1. **Fetch** the full snippet object: `GET /code-snippets/v1/snippets/{id}`
2. **Modify** the `code` field in the response
3. **Remove** `id`, `network`, `shared_network` keys
4. **PUT** the entire modified object back

Sending only `{"code":"...","active":true}` may silently fail to update the code while returning success. Always verify the stored code after updating by fetching and comparing.
